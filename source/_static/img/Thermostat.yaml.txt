esphome
  name lr-thermostat
  friendly_name LR Thermostat

esp32
  board esp32dev
  framework
    type esp-idf

# Enable logging
logger

# Enable Home Assistant API
api
  encryption
    key vyqRHDEUnbbihs1FDaGWeZoHj8PQL+LATqo5+3ynG0=

ota
  - platform esphome
    password 4976077eda6c9e3b6352d37949b2e907

wifi
  ssid !secret wifi_ssid
  password !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap
    ssid Lr-Thermostat Fallback Hotspot
    password uJNMjku0bKVg

globals
  - id last_hvac_off
    type unsigned long
    restore_value no
    initial_value '0'
    
  # Circulation state machine
  - id recirc_active
    type bool
    restore_value no
    initial_value 'false'

  - id recirc_started_ms
    type unsigned long
    restore_value no
    initial_value '0'

  - id last_recirc_end_ms
    type unsigned long
    restore_value no
    initial_value '0'


switch
  # Heat to W2 pin
  - platform gpio 
    name heater
    id heater
    pin GPIO25

  # AC to W1 pin
  - platform gpio 
    name air_cond
    id air_cond
    pin GPIO27

  # Fan High to GH pin
  - platform gpio 
    name fan_high
    id fan_high
    pin GPIO26

  # Fan Low to GL pin
  - platform gpio 
    name fan_low
    id fan_low
    pin GPIO33

  # temperature sensor power
  - platform gpio 
    pin GPIO14
    id ntc_power

sensor

  - platform adc
    pin GPIO34
    id source_sensor
    attenuation 11db
    update_interval never  # Only read when powered

  - platform resistance
    sensor source_sensor
    configuration DOWNSTREAM
    resistor 10kOhm
    reference_voltage 3.3V
    id resistance_sensor

  - platform ntc
    sensor resistance_sensor
    filters
      - exponential_moving_average
          alpha 0.1  
    calibration
      b_constant 3950
      reference_temperature 25°C
      reference_resistance 10kOhm
    id lr_temp_sensor



script
  - id manage_recirc_fan
    mode restart
    then
      - lambda -
           Tuning knobs
          const unsigned long IDLE_BEFORE_FIRST_RUN_MS = 600000;   10 minutes idle before starting
          const unsigned long RECIRC_RUN_MS            = 120000;   2 minutes on
          const unsigned long RECIRC_OFF_MS            = 600000;   10 minutes off between runs

          const unsigned long now = millis();

          auto mode     = id(Thermostat_Climate_Controller).mode;
          auto fan_mode = id(Thermostat_Climate_Controller).fan_mode;
          auto action   = id(Thermostat_Climate_Controller).action;

           Do not manage circulation when HVAC is OFF or in FAN_ONLY.
           If we were running circulation and HVAC is turned OFF, shut our fan off.
          if (mode == CLIMATE_MODE_OFF) {
            if (id(recirc_active)) {
              id(fan_low).turn_off();
              id(recirc_active) = false;
              id(last_recirc_end_ms) = now;
            }
            return;
          }
          if (mode == CLIMATE_MODE_FAN_ONLY) {
             Do not override fan-only behavior
            if (id(recirc_active)) {
              id(recirc_active) = false;
              id(last_recirc_end_ms) = now;
            }
            return;
          }

           If user selected a fan mode (LOWHIGHAUTO), do not override it.
          if (fan_mode != CLIMATE_FAN_OFF) {
            if (id(recirc_active)) {
              id(recirc_active) = false;
              id(last_recirc_end_ms) = now;
            }
            return;
          }

           If HVAC is actively heatingcooling, do not run circulation.
          if (action == CLIMATE_ACTION_HEATING  action == CLIMATE_ACTION_COOLING) {
            if (id(recirc_active)) {
              id(recirc_active) = false;
              id(last_recirc_end_ms) = now;
            }
            return;
          }

           Only circulate while the thermostat is truly idle.
          if (action != CLIMATE_ACTION_IDLE) {
            if (id(recirc_active)) {
              id(recirc_active) = false;
              id(last_recirc_end_ms) = now;
            }
            return;
          }

           If circulation is currently running, stop it after RECIRC_RUN_MS.
          if (id(recirc_active)) {
            if ((now - id(recirc_started_ms)) = RECIRC_RUN_MS) {
              id(fan_low).turn_off();
              id(recirc_active) = false;
              id(last_recirc_end_ms) = now;
            }
            return;
          }

           Not currently running decide if we should start.
           Must be idle long enough since last_hvac_off (set by idle_action).
          if ((now - id(last_hvac_off))  IDLE_BEFORE_FIRST_RUN_MS) return;

           Must also respect the off-time between runs.
          if (id(last_recirc_end_ms) != 0 && (now - id(last_recirc_end_ms))  RECIRC_OFF_MS) return;

           Start circulation on low speed.
          id(fan_low).turn_on();
          id(fan_high).turn_off();
          id(recirc_active) = true;
          id(recirc_started_ms) = now;





interval
  # Circulation manager
  - interval 10s
    then
      - script.execute manage_recirc_fan

  - interval 5s
    then
      - switch.turn_on ntc_power
      - delay 1s
      - component.update source_sensor
      - switch.turn_off ntc_power

# Example dual-point configuration entry
climate
  - platform thermostat
    name Thermostat Climate Controller
    id Thermostat_Climate_Controller
    sensor lr_temp_sensor

    min_cooling_off_time 60s
    min_cooling_run_time 60s
    min_heating_off_time 60s
    min_heating_run_time 60s
    min_fan_mode_switching_time 30s
    min_idle_time 1s

    fan_only_action_uses_fan_mode_timer True

    # Visual Elements of the Thermostat

    visual
      temperature_step
        target_temperature 0.5
        current_temperature 0.1


    

    #  HeatingCooling Configurations

    heat_cool_mode []

    cool_action
      - switch.turn_on air_cond
      - lambda -
          if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_LOW) {
            id(fan_low).turn_on();
            id(fan_high).turn_off();
          } else if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_HIGH) {
            id(fan_high).turn_on();
            id(fan_low).turn_off();
          } else {
            id(fan_low).turn_on();   default for AUTO or OFF fan mode
            id(fan_high).turn_off();
          }
    heat_action
      - switch.turn_on heater
      - lambda -
          if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_LOW) {
            id(fan_low).turn_on();
            id(fan_high).turn_off();
          } else if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_HIGH) {
            id(fan_high).turn_on();
            id(fan_low).turn_off();
          } else {
            id(fan_low).turn_on();   default for AUTO or OFF fan mode
            id(fan_high).turn_off();
          }

    # Idle Configuration

    idle_action
      - switch.turn_off air_cond
      - switch.turn_off heater
      - lambda -
          id(last_hvac_off) = millis();

          if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_OFF) {
            id(fan_low).turn_off();
            id(fan_high).turn_off();
          }

    
    # Fan Configurations

    fan_only_action 
      - lambda -
          if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_LOW) {
            id(fan_low).turn_on();
            id(fan_high).turn_off();
          } else if (id(Thermostat_Climate_Controller).fan_mode == CLIMATE_FAN_HIGH) {
            id(fan_high).turn_on();
            id(fan_low).turn_off();
          }

    fan_mode_off_action
      - lambda -
          auto action = id(Thermostat_Climate_Controller).action;
          if (action == CLIMATE_ACTION_COOLING  action == CLIMATE_ACTION_HEATING) {
            id(fan_low).turn_on();
            id(fan_high).turn_off();
            return;
          } else {
            id(fan_low).turn_off();
            id(fan_high).turn_off();
          }

    fan_mode_low_action
      - switch.turn_on fan_low
      - switch.turn_off fan_high

    fan_mode_high_action
      - switch.turn_off fan_low
      - switch.turn_on fan_high




    # Presets

    default_preset Home
    preset
      - name Home
        fan_mode OFF
        default_target_temperature_low 69 °F
        default_target_temperature_high 72 °F
      - name Away
        fan_mode OFF
        default_target_temperature_low  65 °F
        default_target_temperature_high 75 °F
      - name Far Away
        fan_mode OFF
        default_target_temperature_low 62 °F
        default_target_temperature_high 77 °F




captive_portal


